---
title: "Mitral Valve Replacement Data Simulation"
author: "Gaurika Tyagi"
date: "7 May 2016"
output: html_document
---

<Center><H1><U>Mitral Valve Replacement (50 to 69 year olds)- Bioprosthetic vs Mechanical</U></H1></center>

<H2> Introduction </H2>

Mitral valve disease is a conditions of the mitral valve. This is located between the left chambers of the heart and works to keep blood flowing properly. It allows blood to pass from the left atrium to the left ventricle but prevents it from flowing backwards. People with Mitral disease have a disfunctional mitral valve which allows the flow of blood backwards to the atrium. This disease may lead to heart failure or irregular heartbeats, which may be life threatening.

Many people do not experience any symptom. However, in cases where there are symptoms, they are:

1. Fatigue
2. Shortness of breath

This study focuses on the <b> survival outcomes following bioproshetic v/s mechanical Mitral Valve replacement</b>. It is only based on patients aged between 50-69 years as it is a challenging task to decide between the two because the long-term survival and morbidity are not well defined.

19 baseline characteristics yielded 664 patient pairs.

<B>Definitions</B>
_Morbidity_: Morbidity is used to describe how often a disease occurs in a specific area or to describe a focus on death. In other words, it is the incidence of disease.

_Propensity Score_: In the statistical analysis propensity score matching (PSM) is a statistical matching technique that attempts to estimate the effect of a treatment by accounting for the covariates that predict receiving the treatment.

_Comorbidity_: The simultaneous presence of two chronic diseases or conditions in a patient

<H2> Objective </H2>
The aim of the study is to quantify the survival and morbidity after valve replacement in patients aged 50-69 years.

<H2> Study Results </H2>

1. _Survival Difference_: None at 15 years of observation
2. _Stroke and Bleeding_: Higher in those who received mechanical prosthetic mitral valves compared 
3. _Reoperation_: Lower in the mechanical prosthesis group compared with the bioprosthesis group

<H2>Data Simulation </H2>

Install Libraries

```{r}
#install.packages("ggplot2")
#install.packages("survival")
#install.packages("matchingR")
library(matchingR)
library(ggplot2)
library(survival)

```

<H3>Generate dataset for people who underwent Bioprosthetic Mitral Valve Replacement</H3>

```{r}
genBioProsthetic <- function(number){
  
  #Demographics
  age <- rnorm(n = number, mean = 61.2, sd = 5.9)
  #density distribution of age
  hist(age, main = "Density of age distribution for Bioprosthetics", 
       freq = FALSE, ylim = c(0, 0.08) , xlab = "Age in years")
  lines(density(age), col = "dark green", lty="dotted")

  #we know that 43% of the Bioprosthetics are males
  male <- rep(x = "male", times = floor(0.43*number))
  female <- rep(x = "female", times = ceiling(0.57*number))
  sex_raw <- c(male, female)
  sex <- sample(x = sex_raw, size = number, replace = FALSE)
  #distribution of age by sex
  boxplot(age~sex,  col = (c("pink","blue")),
        main = "Distribution of Age by Sex", xlab = "Sex", ylab = "Age(in years)")

  non_his_w <- rep(x = "Non_Hispanic_White", times = floor(0.57*number))
  non_his_b <- rep(x = "Non_Hispanic_Black", times = floor(0.13*number))
  hisp <- rep(x = "Hispanic", times = ceiling(0.08*number))
  oth <- rep(x = "Other", times = ceiling(0.22*number))
  race_raw <- c(non_his_w, non_his_b, hisp, oth)
  race <- sample(x = race_raw, size = number, replace = FALSE) 
  #distribution of age by race
  boxplot(age~race,  col = (c("Dark Green","blue", "Yellow", "Red")),
        main = "Distribution of Age by Race", xlab = "Race", ylab = "Age(in years)", 
        cex.axis=0.75)

  emergent_admission <- rbinom(n = number, size = 1, prob = 0.55)

  concomitant_tricuspid_valve_repair <- rbinom(n = number, size = 1, prob = 0.05)

  #Comorbidities
  coagulation <- rbinom(n = number, size = 1, prob = 0.07)
  hypertension <- rbinom(n = number, size = 1, prob = 0.59)
  diabetes_mellitus <- rbinom(n = number, size = 1, prob = 0.25)
  sepsis <- rbinom(n = number, size = 1, prob = 0.04)
  coronory_artery_disease_raw <- c(rep(x = "Without_Prior_Revascularization", 
                                       times = ceiling(0.32*number)),
                                 rep(x = "Prior_PCI", times = floor(0.04*number)),
                                 rep(x = "Prior_CABG_Surgery", times = ceiling(0.06*number)),
                                 rep(x = "None", times = ceiling(0.58*number))
                                )
  coronary_artery_disease <- sample(x = coronory_artery_disease_raw, size = number, replace = FALSE)
  congestive_heart_failure <- rbinom(n = number, size = 1, prob = 0.58)
  atrial_fibrillation <- rbinom(n = number, size = 1, prob = 0.43)
  peripheral_vascular_disease <- rbinom(n = number, size = 1, prob = 0.05)
  cerebro_vascular_disease <- rbinom(n = number, size = 1, prob = 0.09)
  chronic_obstructive_pulmonary_disease <- rbinom(n = number, size = 1, prob = 0.23)
  chronic_kidney_disease <- rbinom(n = number, size = 1, prob = 0.11)
  liver_disease <- rbinom(n = number, size = 1, prob = 0.08)
  cancer <- rbinom(n = number, size = 1, prob = 0.05)
  
  #Year of Surgery
  years_raw <- c(rep(x = "1997", times = floor(0.03*number)), 
               rep(x = "1998", times = floor(0.04*number)),
               rep(x = "1999", times = floor(0.05*number)),
               rep(x = "2000", times = floor(0.05*number)),
               rep(x = "2001", times = floor(0.08*number)),
               rep(x = "2002", times = ceiling(0.08*number)),
               rep(x = "2003", times = ceiling(0.09*number)),
               rep(x = "2004", times = ceiling(0.13*number)),
               rep(x = "2005", times = ceiling(0.13*number)),
               rep(x = "2006", times = ceiling(0.15*number)),
               rep(x = "2007", times = ceiling(0.17*number))
               )
  year <- sample(x = years_raw, size = number, replace = FALSE)
  
  group <- rep(x = "bio", size = number, replace = FALSE)

  #collaborate all features to develop data set
  bioprosthetics <- data.frame(age, sex, race, emergent_admission,
                               concomitant_tricuspid_valve_repair, coagulation, hypertension,
                               diabetes_mellitus, sepsis, coronary_artery_disease,
                               congestive_heart_failure, atrial_fibrillation,
                               peripheral_vascular_disease, cerebro_vascular_disease,
                               chronic_obstructive_pulmonary_disease, chronic_kidney_disease,
                               liver_disease, cancer, year, group)

  return(bioprosthetics)
} 
print("Generating dataset for people who had Bioprosthetic Valve replacement")
bioprosthetic_group <- genBioProsthetic(795)
```

Similary now we need to develop the data set for group of people who underwent Mechanical Prosthetic Mitral Valve replacement.

<H3>Generate dataset for people who underwent Mechanical Prosthetic Mitral Valve Replacement</H3>

```{r}
genMechanicalProsthetic <- function(number){
  
  #Demographics
  age <- rnorm(n = number, mean = 59.7, sd = 5.7)
  #density distribution of age
  hist(age, main = "Density of age distribution for Bioprosthetics", 
       freq = FALSE, ylim = c(0, 0.08) , xlab = "Age in years")
  lines(density(age), col = "dark green", lty="dotted")

  #we know that 40% of the Mechanical Prosthetics are males
  male <- rep(x = "male", times = floor(0.40*number))
  female <- rep(x = "female", times = ceiling(0.60*number))
  sex_raw <- c(male, female)
  sex <- sample(x = sex_raw, size = number, replace = FALSE)
  #distribution of age by sex
  boxplot(age~sex,  col = (c("pink","blue")),
        main = "Distribution of Age by Sex", xlab = "Sex", ylab = "Age(in years)")

  non_his_w <- rep(x = "Non_Hispanic_White", times = floor(0.56*number))
  non_his_b <- rep(x = "Non_Hispanic_Black", times = floor(0.11*number))
  hisp <- rep(x = "Hispanic", times = ceiling(0.07*number))
  oth <- rep(x = "Other", times = ceiling(0.26*number))
  race_raw <- c(non_his_w, non_his_b, hisp, oth)
  race <- sample(x = race_raw, size = number, replace = FALSE) 
  #distribution of age by race
  boxplot(age~race,  col = (c("Dark Green","blue", "Yellow", "Red")),
        main = "Distribution of Age by Race", xlab = "Race", ylab = "Age(in years)", 
        cex.axis=0.75)

  emergent_admission <- rbinom(n = number, size = 1, prob = 0.42)

  concomitant_tricuspid_valve_repair <- rbinom(n = number, size = 1, prob = 0.03)

  #Comorbidities
  coagulation <- rbinom(n = number, size = 1, prob = 0.05)
  hypertension <- rbinom(n = number, size = 1, prob = 0.52)
  diabetes_mellitus <- rbinom(n = number, size = 1, prob = 0.17)
  sepsis <- rbinom(n = number, size = 1, prob = 0.02)
  coronory_artery_disease_raw <- c(rep(x = "Without_Prior_Revascularization", 
                                       times = ceiling(0.25*number)),
                                   rep(x = "Prior_PCI", times = floor(0.02*number)),
                                   rep(x = "Prior_CABG_Surgery", times = ceiling(0.04*number)),
                                   rep(x = "None", times = ceiling(0.69*number))
                                  )
  coronary_artery_disease <- sample(x = coronory_artery_disease_raw, size = number, replace = FALSE)

  congestive_heart_failure <- rbinom(n = number, size = 1, prob = 0.53)
  atrial_fibrillation <- rbinom(n = number, size = 1, prob = 0.51)
  peripheral_vascular_disease <- rbinom(n = number, size = 1, prob = 0.03)
  cerebro_vascular_disease <- rbinom(n = number, size = 1, prob = 0.08)
  chronic_obstructive_pulmonary_disease <- rbinom(n = number, size = 1, prob = 0.18)
  chronic_kidney_disease <- rbinom(n = number, size = 1, prob = 0.06)
  liver_disease <- rbinom(n = number, size = 1, prob = 0.04)
  cancer <- rbinom(n = number, size = 1, prob = 0.02)
  
  #Year of Surgery
  years_raw <- c(rep(x = "1997", times = floor(0.12*number)), 
               rep(x = "1998", times = floor(0.12*number)),
               rep(x = "1999", times = floor(0.10*number)),
               rep(x = "2000", times = floor(0.11*number)),
               rep(x = "2001", times = floor(0.10*number)),
               rep(x = "2002", times = ceiling(0.09*number)),
               rep(x = "2003", times = ceiling(0.09*number)),
               rep(x = "2004", times = ceiling(0.08*number)),
               rep(x = "2005", times = ceiling(0.07*number)),
               rep(x = "2006", times = ceiling(0.06*number)),
               rep(x = "2007", times = ceiling(0.06*number))
               )
  year <- sample(x = years_raw, size = number, replace = FALSE)
  group <- rep(x = "mechanical", size = number, replace = FALSE)
  
  #collaborate all features to develop data set
  mechprosthetics <- data.frame(age, sex, race, emergent_admission,
                               concomitant_tricuspid_valve_repair, coagulation, hypertension,
                               diabetes_mellitus, sepsis, coronary_artery_disease,
                               congestive_heart_failure, atrial_fibrillation,
                               peripheral_vascular_disease, cerebro_vascular_disease,
                               chronic_obstructive_pulmonary_disease, chronic_kidney_disease,
                               liver_disease, cancer, year, group)

  return(mechprosthetics)
} 
print("Generating dataset for people who had Mechanical Prosthetic Valve replacement")
mechprosthetic_group <- genMechanicalProsthetic(2638)
```

<H3>Propensity score calculation to identify the matching groups </H3>
```{r}
# To calculate the propensity score, a hierarchical logistic regression model was fitted with 
# bioprosthetic implantation as the outcome.
# Gale-Shapley algorithm to find paired matches

case<- bioprosthetic_group
control.set<-mechprosthetic_group

ncases <- nrow(case) #795
ncontrol.set <- nrow(control.set) # 2638
caseUtils = matrix(0,nrow = ncontrol.set, ncol = ncases)
caseUtils.df <- data.frame(caseUtils)
controlUtils = matrix(0,nrow = ncases, ncol = ncontrol.set)
controlUtils.df <- data.frame(controlUtils)

MAX_ALLOWED_AGE_DIFF <- 10
AGE_WT <- 100
SEX_WT <- 50
RACE_WT <- 75
CANCER_WT <- 5
EMERGENT_WT <- 5

DISQUAL <- -999
QUAL <- 500
QUAL_WT <- 1

num_sex_male <- sum(control.set$sex == "male") #Finding number of males
num_sex_female <- sum(control.set$sex == "female") #Finding number of females

num_race_nonhis_white <- sum(control.set$race == "Non_Hispanic_White")
num_race_nonhis_black <- sum(control.set$race == "Non_Hispanic_Black")
num_race_his <- sum(control.set$race == "Hispanic")
num_race_other <- sum(control.set$race == "Other")

num_cancer <- sum(control.set$cancer == 1)
num_no_cancer <- sum(control.set$cancer == 0)

num_emergency <- sum(control.set$emergent_admission == 1)
num_no_emergency <- sum(control.set$emergent_admission == 0)

for (i in seq_len(nrow(case) ) ){ 
  this.age <- case$age[i]
  this.sex <- case$sex[i]
  this.race <- case$race[i]
  this.cancer <- case$cancer[i]
  this.emergent_admission <- case$emergent_admission[i]
  
  #Calculating the score for age 
  age_score <-  MAX_ALLOWED_AGE_DIFF - abs(control.set$age - this.age)  
  df <- data.frame(age_score)
  
  if (this.sex == "male"){
    sex_score <- ifelse (control.set$sex != this.sex, 0, 1/num_sex_male)
  }else{   # this.status == "+"
    sex_score <- ifelse (control.set$sex != this.sex, 0, 1/num_sex_female)
  }
  df$sex_score <- sex_score

  if (this.race == "Non_Hispanic_White"){
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_nonhis_white)
  }else if (this.race == "Non_Hispanic_Black"){   
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_nonhis_black)
  }else if (this.race == "Hispanic"){   
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_his)
  }else{
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_other)
  }
  df$race_score <- race_score
  
  if (this.cancer == 0){
    cancer_score <- ifelse (control.set$cancer != this.cancer, 0, 1/num_no_cancer)
  }else{  
    cancer_score <- ifelse (control.set$cancer != this.sex, 0, 1/num_cancer)
  }
  df$cancer_score <- cancer_score
  
  if (this.emergent_admission == 0){
    emergency_score <- ifelse (control.set$emergent_admission != this.cancer,
                               0, 1/num_no_emergency)
  }else{  
    emergency_score <- ifelse (control.set$emergent_admission != this.sex, 0,
                               1/num_emergency)
  }
  df$emergency_score <- emergency_score
  
  df$disqual <- ifelse(df$age_score < 0 | df$sex_score <= 0 | df$race_score < 0 | 
                         df$cancer_score < 0 | df$emergency_score <0 , DISQUAL, 0.0 ) 
  
  num_possib_matches <- sum(df$disqual!= DISQUAL)
  qualify <- QUAL / num_possib_matches
  df$qualify <- rep(qualify, nrow(control.set)) 
  
  total_score <- AGE_WT*df$age_score + SEX_WT*df$sex_score + RACE_WT*df$race_score + 
    CANCER_WT*df$cancer_score + EMERGENT_WT*df$emergency_score
  
  df$total_score <- ifelse(df$disqual<= DISQUAL, DISQUAL, total_score)
  df$total_score <- df$total_score + QUAL_WT*df$qualify 
  
  # caseUtils ith column is for the total score for matching the two pairs
  caseUtils.df[,i] <- df$total_score 
  # controlutils ith row is for for the total score for matching the two pairs
  controlUtils.df[i,] <- df$total_score 
}

results <- galeShapley.marriageMarket(caseUtils.df, controlUtils.df) 
#results$proposals 

#The following for loop will check if there is any person in the base group who has not been matched to any other person in the prospective suitors group
for ( i in seq_len(ncases)){
  print(controlUtils.df[i,results$proposals[i] ])
} 

new_mech <- mechprosthetic_group[results$proposals[1:600], ]

#Now reducing the mechanicalprosthetics group and arrangung it accroding to matched pairs from 
#bioprosthetics group


#Now we will check for the stability of the matching to ensure that the matched pairs are the only possible matchings.
#galeShapley.checkStability(caseUtils, controlUtils, results$proposals, results$engagements)
```

Now, we have 795 matching pairs in both mechprosthetics group and bioprsthetics group. Going ahead with these two groups of matching pairs and performng chi2 tests for categorical data and t-tests for continuous data:


#t-test for age
age_t.test <- t.test(new_bioprosthetics$age, new_mechprosthetics$age)
##The p-value of 1.591e-06 for age variable in matched bio-prosthetics group and mechprosthetics group suggests that they are independent as the probability distribution of one variable is not affected by the presence of another.

#chi2 test can only be applied on data sets of equal lengths
race_chi <- chisq.test(table(new_bioprosthetics$race, new_mechprosthetics$race))
## p-value = 0.03611 rejects the null hypothesis that these two features are dependent

emergent_admission_chi <- chisq.test(table(new_bioprosthetics$emergent_admission,
                                           new_mechprosthetics$emergent_admission))
##  p-value = 0.9792 not enough evidence to reject the null hypothesis of the two results being independent

concomitant_tricuspid_valve_repair_chi <-
  chisq.test(table(new_bioprosthetics$concomitant_tricuspid_valve_repair,                                 new_mechprosthetics$concomitant_tricuspid_valve_repair))
coagulation_chi <- chisq.test(table(new_bioprosthetics$coagulation,
                                    new_mechprosthetics$coagulation))
hypertension_chi <- chisq.test(table(new_bioprosthetics$hypertension,
                                     new_mechprosthetics$hypertension))
diabetes_mellitus_chi <- chisq.test(table(new_bioprosthetics$diabetes_mellitus,
                                          new_mechprosthetics$diabetes_mellitus))
sepsis_chi <-
coronory_artery_chi <- chisq.test(table(new_bioprosthetics$sepsis, new_mechprosthetics$sepsis))
atrial_fibrillation_chi <- chisq.test(table(new_bioprosthetics$atrial_fibrillation,
                                            new_mechprosthetics$atrial_fibrillation))
peripheral_vascular_chi <- chisq.test(table(new_bioprosthetics$peripheral_vascular_disease,
                                            new_mechprosthetics$peripheral_vascular_disease))
cerebro_vascular_chi <- chisq.test(table(new_bioprosthetics$cerebro_vascular_disease,
                                         new_mechprosthetics$cerebro_vascular_disease))
chronic_obstructive_pulmonary_chi <-
  chisq.test(table(new_bioprosthetics$chronic_obstructive_pulmonary_disease,
                   new_mechprosthetics$chronic_obstructive_pulmonary_disease))
chronic_kidney_chi <- chisq.test(table(new_bioprosthetics$chronic_kidney_disease,
                                       new_mechprosthetics$chronic_kidney_disease))
liver_disease_chi <- chisq.test(table(new_bioprosthetics$liver_disease, 
                                      new_mechprosthetics$liver_disease))
cancer_chi <- chisq.test(table(new_bioprosthetics$cancer, new_mechprosthetics$cancer))

#mcnemar.test(as.matrix(new_bioprosthetics$race), y = NULL)

#new_model <- as.data.frame(sample(c(new_bioprosthetics, new_mechprosthetics), replace = FALSE))
#coxph(group~., data = new_model)

Now, we will generate the survival data 

```{r}
#genSurvivalBioprosthetic <- function(number_matched){
 # mortality <- 
#}
```