---
title: "Mitral Valve Replacement Data Simulation"
author: "Gaurika Tyagi"
date: "7 May 2016"
output: html_document
---

<Center><H1><U>Mitral Valve Replacement (50 to 69 year olds)- Bioprosthetic vs Mechanical</U></H1></center>

<H2> Introduction </H2>

Mitral valve disease is a conditions of the mitral valve. This is located between the left chambers of the heart and works to keep blood flowing properly. It allows blood to pass from the left atrium to the left ventricle but prevents it from flowing backwards. People with Mitral disease have a disfunctional mitral valve which allows the flow of blood backwards to the atrium. This disease may lead to heart failure or irregular heartbeats, which may be life threatening.

Many people do not experience any symptom. However, in cases where there are symptoms, they are:

1. Fatigue
2. Shortness of breath

This study focuses on the <b> survival outcomes following bioproshetic v/s mechanical Mitral Valve replacement</b>. It is only based on patients aged between 50-69 years as it is a challenging task to decide between the two because the long-term survival and morbidity are not well defined.

19 baseline characteristics yielded 664 patient pairs.

<B>Definitions</B>
_Morbidity_: Morbidity is used to describe how often a disease occurs in a specific area or to describe a focus on death. In other words, it is the incidence of disease.

_Propensity Score_: In the statistical analysis propensity score matching (PSM) is a statistical matching technique that attempts to estimate the effect of a treatment by accounting for the covariates that predict receiving the treatment.

_Comorbidity_: The simultaneous presence of two chronic diseases or conditions in a patient

<H2> Objective </H2>
The aim of the study is to quantify the survival and morbidity after valve replacement in patients aged 50-69 years.

<H2> Study Results </H2>

1. _Survival Difference_: None at 15 years of observation
2. _Stroke and Bleeding_: Higher in those who received mechanical prosthetic mitral valves compared 
3. _Reoperation_: Lower in the mechanical prosthesis group compared with the bioprosthesis group

<H2>Data Introduction</H2>

This data simulation study aims to explore the survival outcome in people who have undergone a Mitral Valve replacement. Specifically, people who had bioprosthetic valve replacement viz-a-viz a mechanical valve replacement. Presence of various comorbidities along with this replacement are also kept in the picture. These are: coagulation, hypertension, diabetes mellitus, sepsis, coronary artery disease, congestive heart failure, atrial fibrillation, peripheral vascular disease, cerebro vascular disease, chronic obstructive pulmonary disease, chronic kidney disease, liver disease and cancer.

Initially, 2 datasets will be simulated:

1.	People who underwent bioprosthetics valve replacement: dataset dimensions (795 rows, 20 columns)

2.	People who underwent mechanical prosthetics valve replacement: dataset dimensions (2638 rows, 20 columns)

Finally, these will be paired and the data set will be reduced to 664 rows in each of the above mentioned datasets. Wemwill then add a column for whether these people are dead or alive (the research paper only talks about mortality once the matched pairing has been taken care of).

Important points about the predictor variables:

*Age is normally distributed.

*Sex, Race and Age were given as a proportion so it is a random distribution. 

*All other variables are Bernoulli distributions based on their probability of occurrence.

*Group is defined based on if they belong to the bio-prosthetics group or the mechanical prosthetics group. 

*There is no missing data in this simulation.

*The response variable is simulated later as a variable in the matched data frames as a Boolean variable with 0 for no death and 1 for death. It will be simulated based on the comorbidities recorded.

*The response variable death has the following positively correlated factors: cancer, congestive heart failure, age>60 and if the person was brought in in an emergency.

*Confounders are not being added while data simulation but we will explore their presence when performing correlation analysis

Pairing of the preliminary data-sets will be done on the baisis of demographics and comorbidities.
We will utilize the paired datasets and fit models to understand the effect of one variable on another. We will also merge the two data sets and try and understand how the analysis would differ if the datasets were not paired. Plots will also be generated to depict correlation and the various distributions.

We will utilize the paired datasets and fit models to understand the effect of one variable on another. We will also merge the two data sets and try and understand how the analysis would differ if the datasets were not paired. Plots will also be generated to depict correlation and the various distributions.

<H2>Data Simulation </H2>

Install Libraries

```{r}
#install.packages("ggplot2")
#install.packages("survival")
#install.packages("matchingR")
#install.packages("kimisc")
#install.packages("useful")
#install.packages("rpart")
library(rpart)
library(rpart.plot)
library(useful)
library(matchingR)
library(ggplot2)
library(survival)
library(kimisc)
library(reshape2)
```

<H3>Generate dataset for people who underwent Bioprosthetic Mitral Valve Replacement</H3>

```{r}
set.seed(0)
genBioProsthetic <- function(number){
  
  #Demographics
  age <- rnorm(n = number, mean = 61.2, sd = 5.9)
  #density distribution of age
  hist(age, main = "Density of age distribution for Bioprosthetics", 
       freq = FALSE, ylim = c(0, 0.08) , xlab = "Age in years")
  lines(density(age), col = "dark green", lty="dotted")

  #we know that 43% of the Bioprosthetics are males
  male <- rep(x = "male", times = floor(0.43*number))
  female <- rep(x = "female", times = ceiling(0.57*number))
  sex_raw <- c(male, female)
  sex <- sample(x = sex_raw, size = number, replace = FALSE)
  #distribution of age by sex
  boxplot(age~sex,  col = (c("pink","blue")),
        main = "Distribution of Age by Sex", xlab = "Sex", ylab = "Age(in years)")

  non_his_w <- rep(x = "Non_Hispanic_White", times = floor(0.57*number))
  non_his_b <- rep(x = "Non_Hispanic_Black", times = floor(0.13*number))
  hisp <- rep(x = "Hispanic", times = ceiling(0.08*number))
  oth <- rep(x = "Other", times = ceiling(0.22*number))
  race_raw <- c(non_his_w, non_his_b, hisp, oth)
  race <- sample(x = race_raw, size = number, replace = FALSE) 
  #distribution of age by race
  boxplot(age~race,  col = (c("Dark Green","blue", "Yellow", "Red")),
        main = "Distribution of Age by Race", xlab = "Race", ylab = "Age(in years)", 
        cex.axis=0.75)

  emergent_admission <- rbinom(n = number, size = 1, prob = 0.55)

  concomitant_tricuspid_valve_repair <- rbinom(n = number, size = 1, prob = 0.05)

  #Comorbidities
  coagulation <- rbinom(n = number, size = 1, prob = 0.07)
  hypertension <- rbinom(n = number, size = 1, prob = 0.59)
  diabetes_mellitus <- rbinom(n = number, size = 1, prob = 0.25)
  sepsis <- rbinom(n = number, size = 1, prob = 0.04)
  coronory_artery_disease_raw <- c(rep(x = "Without_Prior_Revascularization", 
                                       times = ceiling(0.32*number)),
                                 rep(x = "Prior_PCI", times = floor(0.04*number)),
                                 rep(x = "Prior_CABG_Surgery", times = ceiling(0.06*number)),
                                 rep(x = "None", times = ceiling(0.58*number))
                                )
  coronary_artery_disease <- sample(x = coronory_artery_disease_raw, size = number, replace = FALSE)
  congestive_heart_failure <- rbinom(n = number, size = 1, prob = 0.58)
  atrial_fibrillation <- rbinom(n = number, size = 1, prob = 0.43)
  peripheral_vascular_disease <- rbinom(n = number, size = 1, prob = 0.05)
  cerebro_vascular_disease <- rbinom(n = number, size = 1, prob = 0.09)
  chronic_obstructive_pulmonary_disease <- rbinom(n = number, size = 1, prob = 0.23)
  chronic_kidney_disease <- rbinom(n = number, size = 1, prob = 0.11)
  liver_disease <- rbinom(n = number, size = 1, prob = 0.08)
  cancer <- rbinom(n = number, size = 1, prob = 0.05)
  
  #Year of Surgery
  years_raw <- c(rep(x = "1997", times = floor(0.03*number)), 
               rep(x = "1998", times = floor(0.04*number)),
               rep(x = "1999", times = floor(0.05*number)),
               rep(x = "2000", times = floor(0.05*number)),
               rep(x = "2001", times = floor(0.08*number)),
               rep(x = "2002", times = ceiling(0.08*number)),
               rep(x = "2003", times = ceiling(0.09*number)),
               rep(x = "2004", times = ceiling(0.13*number)),
               rep(x = "2005", times = ceiling(0.13*number)),
               rep(x = "2006", times = ceiling(0.15*number)),
               rep(x = "2007", times = ceiling(0.17*number))
               )
  year <- sample(x = years_raw, size = number, replace = FALSE)
  
  group <- rep(x = "bio", size = number, replace = FALSE)

  #collaborate all features to develop data set
  bioprosthetics <- data.frame(age, sex, race, emergent_admission,
                               concomitant_tricuspid_valve_repair, coagulation, hypertension,
                               diabetes_mellitus, sepsis, coronary_artery_disease,
                               congestive_heart_failure, atrial_fibrillation,
                               peripheral_vascular_disease, cerebro_vascular_disease,
                               chronic_obstructive_pulmonary_disease, chronic_kidney_disease,
                               liver_disease, cancer, year, group)

  return(bioprosthetics)
} 
print("Generating dataset for people who had Bioprosthetic Valve replacement")
bioprosthetic_group <- genBioProsthetic(795)
```

Similary now we need to develop the data set for group of people who underwent Mechanical Prosthetic Mitral Valve replacement.

<H3>Generate dataset for people who underwent Mechanical Prosthetic Mitral Valve Replacement</H3>

```{r}
genMechanicalProsthetic <- function(number){
  
  #Demographics
  age <- rnorm(n = number, mean = 59.7, sd = 5.7)
  #density distribution of age
  hist(age, main = "Density of age distribution for Bioprosthetics", 
       freq = FALSE, ylim = c(0, 0.08) , xlab = "Age in years")
  lines(density(age), col = "dark green", lty="dotted")

  #we know that 40% of the Mechanical Prosthetics are males
  male <- rep(x = "male", times = floor(0.40*number))
  female <- rep(x = "female", times = ceiling(0.60*number))
  sex_raw <- c(male, female)
  sex <- sample(x = sex_raw, size = number, replace = FALSE)
  #distribution of age by sex
  boxplot(age~sex,  col = (c("pink","blue")),
        main = "Distribution of Age by Sex", xlab = "Sex", ylab = "Age(in years)")

  non_his_w <- rep(x = "Non_Hispanic_White", times = floor(0.56*number))
  non_his_b <- rep(x = "Non_Hispanic_Black", times = floor(0.11*number))
  hisp <- rep(x = "Hispanic", times = ceiling(0.07*number))
  oth <- rep(x = "Other", times = ceiling(0.26*number))
  race_raw <- c(non_his_w, non_his_b, hisp, oth)
  race <- sample(x = race_raw, size = number, replace = FALSE) 
  #distribution of age by race
  boxplot(age~race,  col = (c("Dark Green","blue", "Yellow", "Red")),
        main = "Distribution of Age by Race", xlab = "Race", ylab = "Age(in years)", 
        cex.axis=0.75)

  emergent_admission <- rbinom(n = number, size = 1, prob = 0.42)

  concomitant_tricuspid_valve_repair <- rbinom(n = number, size = 1, prob = 0.03)

  #Comorbidities
  coagulation <- rbinom(n = number, size = 1, prob = 0.05)
  hypertension <- rbinom(n = number, size = 1, prob = 0.52)
  diabetes_mellitus <- rbinom(n = number, size = 1, prob = 0.17)
  sepsis <- rbinom(n = number, size = 1, prob = 0.02)
  coronory_artery_disease_raw <- c(rep(x = "Without_Prior_Revascularization", 
                                       times = ceiling(0.25*number)),
                                   rep(x = "Prior_PCI", times = floor(0.02*number)),
                                   rep(x = "Prior_CABG_Surgery", times = ceiling(0.04*number)),
                                   rep(x = "None", times = ceiling(0.69*number))
                                  )
  coronary_artery_disease <- sample(x = coronory_artery_disease_raw, size = number, replace = FALSE)

  congestive_heart_failure <- rbinom(n = number, size = 1, prob = 0.53)
  atrial_fibrillation <- rbinom(n = number, size = 1, prob = 0.51)
  peripheral_vascular_disease <- rbinom(n = number, size = 1, prob = 0.03)
  cerebro_vascular_disease <- rbinom(n = number, size = 1, prob = 0.08)
  chronic_obstructive_pulmonary_disease <- rbinom(n = number, size = 1, prob = 0.18)
  chronic_kidney_disease <- rbinom(n = number, size = 1, prob = 0.06)
  liver_disease <- rbinom(n = number, size = 1, prob = 0.04)
  cancer <- rbinom(n = number, size = 1, prob = 0.02)
  
  #Year of Surgery
  years_raw <- c(rep(x = "1997", times = floor(0.12*number)), 
               rep(x = "1998", times = floor(0.12*number)),
               rep(x = "1999", times = floor(0.10*number)),
               rep(x = "2000", times = floor(0.11*number)),
               rep(x = "2001", times = floor(0.10*number)),
               rep(x = "2002", times = ceiling(0.09*number)),
               rep(x = "2003", times = ceiling(0.09*number)),
               rep(x = "2004", times = ceiling(0.08*number)),
               rep(x = "2005", times = ceiling(0.07*number)),
               rep(x = "2006", times = ceiling(0.06*number)),
               rep(x = "2007", times = ceiling(0.06*number))
               )
  year <- sample(x = years_raw, size = number, replace = FALSE)
  group <- rep(x = "mechanical", size = number, replace = FALSE)
  
  #collaborate all features to develop data set
  mechprosthetics <- data.frame(age, sex, race, emergent_admission,
                               concomitant_tricuspid_valve_repair, coagulation, hypertension,
                               diabetes_mellitus, sepsis, coronary_artery_disease,
                               congestive_heart_failure, atrial_fibrillation,
                               peripheral_vascular_disease, cerebro_vascular_disease,
                               chronic_obstructive_pulmonary_disease, chronic_kidney_disease,
                               liver_disease, cancer, year, group)

  return(mechprosthetics)
} 
print("Generating dataset for people who had Mechanical Prosthetic Valve replacement")
mechprosthetic_group <- genMechanicalProsthetic(2638)
```

<H3>Propensity score calculation to identify the matching groups </H3>
```{r}
# To calculate the propensity score, a hierarchical logistic regression model was fitted with 
# bioprosthetic implantation as the outcome.
# Gale-Shapley algorithm to find paired matches

case<- bioprosthetic_group
control.set<-mechprosthetic_group

ncases <- nrow(case) #795
ncontrol.set <- nrow(control.set) # 2638
caseUtils = matrix(0,nrow = ncontrol.set, ncol = ncases)
caseUtils.df <- data.frame(caseUtils)
controlUtils = matrix(0,nrow = ncases, ncol = ncontrol.set)
controlUtils.df <- data.frame(controlUtils)

MAX_ALLOWED_AGE_DIFF <- 10
AGE_WT <- 100
SEX_WT <- 50
RACE_WT <- 75
CANCER_WT <- 5
EMERGENT_WT <- 5

DISQUAL <- -999
QUAL <- 500
QUAL_WT <- 1

num_sex_male <- sum(control.set$sex == "male") #Finding number of males
num_sex_female <- sum(control.set$sex == "female") #Finding number of females

num_race_nonhis_white <- sum(control.set$race == "Non_Hispanic_White")
num_race_nonhis_black <- sum(control.set$race == "Non_Hispanic_Black")
num_race_his <- sum(control.set$race == "Hispanic")
num_race_other <- sum(control.set$race == "Other")

num_cancer <- sum(control.set$cancer == 1)
num_no_cancer <- sum(control.set$cancer == 0)

num_emergency <- sum(control.set$emergent_admission == 1)
num_no_emergency <- sum(control.set$emergent_admission == 0)

for (i in seq_len(nrow(case) ) ){ 
  this.age <- case$age[i]
  this.sex <- case$sex[i]
  this.race <- case$race[i]
  this.cancer <- case$cancer[i]
  this.emergent_admission <- case$emergent_admission[i]
  
  #Calculating the score for age 
  age_score <-  MAX_ALLOWED_AGE_DIFF - abs(control.set$age - this.age)  
  df <- data.frame(age_score)
  
  if (this.sex == "male"){
    sex_score <- ifelse (control.set$sex != this.sex, 0, 1/num_sex_male)
  }else{   # this.status == "+"
    sex_score <- ifelse (control.set$sex != this.sex, 0, 1/num_sex_female)
  }
  df$sex_score <- sex_score

  if (this.race == "Non_Hispanic_White"){
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_nonhis_white)
  }else if (this.race == "Non_Hispanic_Black"){   
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_nonhis_black)
  }else if (this.race == "Hispanic"){   
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_his)
  }else{
    race_score <- ifelse (control.set$race != this.race, 0, 1/num_race_other)
  }
  df$race_score <- race_score
  
  if (this.cancer == 0){
    cancer_score <- ifelse (control.set$cancer != this.cancer, 0, 1/num_no_cancer)
  }else{  
    cancer_score <- ifelse (control.set$cancer != this.sex, 0, 1/num_cancer)
  }
  df$cancer_score <- cancer_score
  
  if (this.emergent_admission == 0){
    emergency_score <- ifelse (control.set$emergent_admission != this.cancer,
                               0, 1/num_no_emergency)
  }else{  
    emergency_score <- ifelse (control.set$emergent_admission != this.sex, 0,
                               1/num_emergency)
  }
  df$emergency_score <- emergency_score
  
  df$disqual <- ifelse(df$age_score < 0 | df$sex_score <= 0 | df$race_score < 0 | 
                         df$cancer_score < 0 | df$emergency_score <0 , DISQUAL, 0.0 ) 
  
  num_possib_matches <- sum(df$disqual!= DISQUAL)
  qualify <- QUAL / num_possib_matches
  df$qualify <- rep(qualify, nrow(control.set)) 
  
  total_score <- AGE_WT*df$age_score + SEX_WT*df$sex_score + RACE_WT*df$race_score + 
    CANCER_WT*df$cancer_score + EMERGENT_WT*df$emergency_score
  
  df$total_score <- ifelse(df$disqual<= DISQUAL, DISQUAL, total_score)
  df$total_score <- df$total_score + QUAL_WT*df$qualify 
  
  # caseUtils ith column is for the total score for matching the two pairs
  caseUtils.df[,i] <- df$total_score 
  # controlutils ith row is for for the total score for matching the two pairs
  controlUtils.df[i,] <- df$total_score 
}

results <- galeShapley.marriageMarket(caseUtils.df, controlUtils.df) 
#results$proposals 

#The following for loop will check if there is any person in the base group who has not been matched to any other person in the prospective suitors group
check <- TRUE
for ( i in seq_len(ncases)){
  
  if(controlUtils.df[i,results$proposals[i] ] <= 0){
    check <- FALSE
  }
  if (check == FALSE){
    print("Item not matched. Exiting...")
    stop()
  }
} 

#There are no unmatched pairs. This can also be seen from results$single.proposers
#ncases determines the total number of matched pairs. This is the size of the bioprosthetic group. i.e 795

#Now we will check for the stability of the matching to ensure that the matched pairs are the only possible matchings.
print( paste("This pairing is stable:", galeShapley.checkStability(as.matrix(caseUtils.df), as.matrix(controlUtils.df), results$proposals, results$engagements)))

#The TRUE shows that the achieved matching is a very stable matching that we have obtained: most optimal

#The paper selects 664 matches, we will reduce 795 matches to 664 because we have to add the death variable in the two datasets. (The paper does not actually give out the explicit matching criteria and we have developed our own criteria.) Selecting the best 664 matches.
dynamic_proposal_scores <- c()
for ( i in seq_len(ncases)){
  dynamic_proposal_scores<- c(dynamic_proposal_scores, 
                              (controlUtils.df[i,results$proposals[i]]))
}

x_mean <- mean(as.matrix(dynamic_proposal_scores)) #998.4157
x_max <- sapply(dynamic_proposal_scores, max)[1] #998.5341
bio_indices<-c()
#Now we know the scores for the best match and the mean match. We develop an algorithm to extract the  row numbers for the best 664 matches 
for (i in seq_len(ncases)){
  if(controlUtils.df[i,results$proposals[i]]> (x_max-0.795*(x_max- x_mean))){
    bio_indices<-c(bio_indices,i)
  }
}
#length(bio_indices) #664
new_bioprosthetics <- bioprosthetic_group[bio_indices,]

#We have the best 664 matches in new_bioprosthetics. Now, extracting the corresponding best matches from the mechprosthetics_group to a new data.frame

#Extract the corresponding mechanical prosthetics from these bio_indices in the results$proposals variable
mech_indices <- results$proposals[bio_indices]
new_mechprosthetics <- mechprosthetic_group[mech_indices, ]
#nrow(new_mechprosthetics) #664
#nrow(new_bioprosthetics) #664

```

We have reduced the mechanicalprosthetics group arranged accoroding to matched pairs from the bioprosthetics group. There are 664 observation in the matched datasets.

<B>Applying chi2 tests to the comorbidities in the two data-sets to test for matching sets</B>

```{r}
coagulation_chi <- chisq.test(table(new_bioprosthetics$coagulation,
                                    new_mechprosthetics$coagulation), simulate.p.value = TRUE)
print(coagulation_chi)
# p-value of 0.3513 shows the we dont have enough evidence to reject the null hypothesis that the coagulation in new_bioprosthetics is independent of the coagulaton in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

hypertension_chi <- chisq.test(table(new_bioprosthetics$hypertension,
                                     new_mechprosthetics$hypertension))
print(hypertension_chi)
# p-value of 0.6745 shows the we dont have enough evidence to reject the null hypothesis that the hypertencion in new_bioprosthetics is independent of the hypertension in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

diabetes_mellitus_chi <- chisq.test(table(new_bioprosthetics$diabetes_mellitus,
                                          new_mechprosthetics$diabetes_mellitus))
print(diabetes_mellitus_chi)
# p-value of 0.3771 shows the we dont have enough evidence to reject the null hypothesis that the diabetes in new_bioprosthetics is independent of the diabetes in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

sepsis_chi <- chisq.test(table(new_bioprosthetics$sepsis, new_mechprosthetics$sepsis), 
                                    simulate.p.value = TRUE)
print(sepsis_chi)
# p-value of 0.3818 shows the we dont have enough evidence to reject the null hypothesis that the sepsis in new_bioprosthetics is independent of the sepsis in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

coronory_artery_chi <- chisq.test(table(new_bioprosthetics$coronary_artery_disease, 
                                        new_mechprosthetics$coronary_artery_disease), 
                                    simulate.p.value = TRUE)

print(coronory_artery_chi)
# p-value of 0.9785 shows the we dont have enough evidence to reject the null hypothesis that the coronary artery disease in new_bioprosthetics is independent of the cronary artery disease in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

atrial_fibrillation_chi <- chisq.test(table(new_bioprosthetics$atrial_fibrillation,
                                            new_mechprosthetics$atrial_fibrillation))
print(atrial_fibrillation_chi)
# p-value of 0.7551 shows the we dont have enough evidence to reject the null hypothesis that the coronary artery disease in new_bioprosthetics is independent of the cronary artery disease in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

peripheral_vascular_chi <- chisq.test(table(new_bioprosthetics$peripheral_vascular_disease,
                                            new_mechprosthetics$peripheral_vascular_disease), 
                                      simulate.p.value = TRUE)
print(peripheral_vascular_chi)
# p-value of 1 shows the we dont have enough evidence to reject the null hypothesis that the peripheral vascular disease in new_bioprosthetics is independent of the peripheral vascular in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

cerebro_vascular_chi <- chisq.test(table(new_bioprosthetics$cerebro_vascular_disease,
                                         new_mechprosthetics$cerebro_vascular_disease))
print(cerebro_vascular_chi)
# p-value of 0.0289 shows the we have enough evidence to reject the null hypothesis that the cerebro vascular disease in new_bioprosthetics is independent of the cerebro vascular in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.This might be because we did not consider this feature for the purpose of matching

chronic_obstructive_pulmonary_chi <-
  chisq.test(table(new_bioprosthetics$chronic_obstructive_pulmonary_disease,
                   new_mechprosthetics$chronic_obstructive_pulmonary_disease))
print(chronic_obstructive_pulmonary_chi)
# p-value of 0.7481 shows the we dont have enough evidence to reject the null hypothesis that the chronic obstructive pulmonary disease in new_bioprosthetics is independent of the chronic obstructive pulmonary in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

chronic_kidney_chi <- chisq.test(table(new_bioprosthetics$chronic_kidney_disease,
                                       new_mechprosthetics$chronic_kidney_disease))
print(chronic_kidney_chi)
# p-value of 1 shows the we dont have enough evidence to reject the null hypothesis that the chronic kidney  disease in new_bioprosthetics is independent of the peripheral vascular in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

liver_disease_chi <- chisq.test(table(new_bioprosthetics$liver_disease, 
                                      new_mechprosthetics$liver_disease),
                                simulate.p.value = TRUE)
print(liver_disease_chi)
# p-value of 0.7411 shows the we dont have enough evidence to reject the null hypothesis that the liver disease in new_bioprosthetics is independent of the liver disease in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.

cancer_chi <- chisq.test(table(new_bioprosthetics$cancer, new_mechprosthetics$cancer),
                         simulate.p.value = TRUE)

print(cancer_chi)
# p-value of 0.6587 shows the we dont have enough evidence to reject the null hypothesis that the cancer in new_bioprosthetics is independent of the cancer in new_mechprosthetics. This is what we wanted to check as we have paired the data by matching, these should not be independent.
```

Adding a column for death based on comorbidities and the groups they belong to.

```{r}
genDeath <- function(data, group_factor, group_cut_off){
  has_cancer <- 2 * group_factor
  has_congestive_heart_failure <- 1 * group_factor
  has_emergency <- 1
  has_age_greater_60 <- 2 * group_factor
  score <- rep(x = 0, times = nrow(data) )

  data <- new_mechprosthetics
  for (i in seq_len(nrow(data) ) ){ 
    this.age <- data$age[i]
    this.cancer <- data$cancer[i]
    this.congestive_heart_failure <- data$congestive_heart_failure[i]
    this.emergent_admission <- data$emergent_admission[i]
    score[i] <- score[i] + ifelse(this.age >60, has_age_greater_60, 0) + 
                ifelse(this.cancer == 1, has_cancer, 0) + 
                ifelse(this.congestive_heart_failure == 1, has_congestive_heart_failure, 0) + 
                ifelse(this.emergent_admission == 1, has_emergency, 0)
    }
  data$death <- ifelse(score>group_cut_off, 1, 0)
  return(data$death)
}

#Numbr of deaths in bio-prostetics was slighly more than those in mechanical prosthetics group. Accounting for those by giving a group factor and group cut off for the death deciding score in each iteration of generation of death value.

death_mechprosthetics <- new_mechprosthetics
death_mechprosthetics$death <- genDeath(death_mechprosthetics, 2.15, 5.5)
#length(which(death_mechprosthetics$death == 1)) # 196 death cases

death_bioprosthetics <- new_bioprosthetics
death_bioprosthetics$death <- genDeath(death_bioprosthetics, 1.8, 4.1)
#length(which(death_bioprosthetics$death == 1)) # 263 death cases
```

Now, we have matched pairs of two different sets of people: those who underwent bioprosthetic valve replacement and those who underwent mechaniacl brosthetic valve replacement; both with a field for whether these people died.

<H2> Simulated Data Exploration </H2>

<H4> Summary of Bioprosthetics group </H4>

```{r}
summary(death_bioprosthetics)
```

<H4> Summary of Mechanical prosthetics group </H4>

```{r}
summary(death_mechprosthetics)
```

<H4> Exploration by plotting </H4>

<B> Bioprosthetic Group</B>

```{r}

ggplot(data = death_bioprosthetics, 
            aes(x = age, y = as.factor(diabetes_mellitus), color = as.factor(death))) + 
  geom_point() + 
  labs(x="Age (in years)", y="Presence of diabetes", title="Diabetes as a function of age: \nGrouped by death cases") + 
  theme(plot.title = element_text(size=20, face="bold", vjust=1, lineheight=0.6), 
        legend.title = element_text(colour="forestgreen", size=16, face="bold"), 
        axis.title.x = element_text(color="forestgreen", vjust=-0.35),
      axis.title.y = element_text(color="forestgreen" , vjust=0.35))+
  scale_color_discrete(name="Death")


ggplot(data = death_bioprosthetics,
       aes(x = sex, y = age))+
  geom_point(color="aquamarine4")+facet_wrap(~race, nrow=1)+ 
  labs(x="Sex ", y="Age", title="Age as a function of sex: \nSplit by race")


ggplot(data = death_bioprosthetics, aes(age,as.factor(cancer), color = as.factor(death)))+
  geom_point()+
    facet_grid(year~race)+ 
  labs(x="Age ", y="Cancer", title="Cancer as a function of Age: \nSplit by year and race") + theme(plot.title = element_text(size=20, face="bold", vjust=1, lineheight=0.6), 
        legend.title = element_text(colour="forestgreen", size=10, face="bold"), 
        axis.title.x = element_text(color="forestgreen", vjust=-0.35),
      axis.title.y = element_text(color="forestgreen" , vjust=0.35))+
  scale_color_discrete(name="Death") 


ggplot(data = death_bioprosthetics, aes(as.factor(congestive_heart_failure), age)) +
  geom_violin(alpha=0.5, color="gray") + 
  geom_jitter(alpha=0.5, aes(color = as.factor(death)), position = position_jitter(width = 0.1)) +
  coord_flip() + 
  labs(x="Congestive Heart Failure ", y="Age", title="Congestive Heart Failure as a function of Age: \nSplit by death") +
  theme(plot.title = element_text(size=20, face="bold", vjust=1, lineheight=0.6)) +
  scale_color_discrete(name="Death")


thecor <- round(cor(death_bioprosthetics[,sort(c("age", "emergent_admission", 
                                               "concomitant_tricuspid_valve_repair", "coagulation",
                                               "hypertension","diabetes_mellitus", "sepsis",
                                               "congestive_heart_failure", "atrial_fibrillation",
                                               "peripheral_vascular_disease", 
                                               "cerebro_vascular_disease", 
                                               "chronic_obstructive_pulmonary_disease",
                                               "chronic_kidney_disease", "liver_disease", "cancer",
                                               "death"))], 
                  method="pearson", 
                  use="pairwise.complete.obs"), 
              2)
thecor[lower.tri(thecor)]<-NA
#thecor

thecor<-melt(thecor)
thecor$Var1<-as.character(thecor$Var1)
thecor$Var2<-as.character(thecor$Var2)
#Now we will use the "long" format using the melt function from the reshape2 package and I'll drop the records with NA values.
thecor<-na.omit(thecor)

ggplot(thecor, aes(Var2, Var1))+
 geom_tile(data=thecor, aes(fill=value), color="white")+
 scale_fill_gradient2(low="red", high="green", mid="white", 
  midpoint=0, limit=c(-1,1),name="Correlation\n(Pearson)")+
 theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))+
 coord_equal() + 
  labs(title="Correlations in bio prosthetics group", x = "", y = "")
```

Positive Correlations
We can see that there are is a strong correlations in the data. Death and age are highly positively correlated. This is so because we coded it that way. Another important point to notice is that even though we did not generate a correlation of death with hypertention, our data suggests a positive correlation between the two. 

Negative Correlation
Peripheral Vascular disease and Atrial fibrillation depict strong negative correlation. From our dataset it is highly unlikely that both exist together. Similarly, concomitant tricuspid valve repair and atrial fibrilation are negatuvely correlated. 


<B> Mechanical prosthetic </B>

```{r}

ggplot(data = death_mechprosthetics, 
            aes(x = age, y = as.factor(diabetes_mellitus), color = as.factor(death))) + 
  geom_point() + 
  labs(x="Age (in years)", y="Presence of diabetes", title="Diabetes as a function of age: \nGrouped by death cases") + 
  theme(plot.title = element_text(size=20, face="bold", vjust=1, lineheight=0.6), 
        legend.title = element_text(colour="forestgreen", size=16, face="bold"), 
        axis.title.x = element_text(color="forestgreen", vjust=-0.35),
      axis.title.y = element_text(color="forestgreen" , vjust=0.35))+
  scale_color_discrete(name="Death")


ggplot(data = death_mechprosthetics,
       aes(x = sex, y = age))+
  geom_point(color="aquamarine4")+facet_wrap(~race, nrow=1)+ 
  labs(x="Sex ", y="Age", title="Age as a function of sex: \nSplit by race")


ggplot(data = death_mechprosthetics, aes(age,as.factor(cancer), color = as.factor(death)))+
  geom_point()+
    facet_grid(year~race)+ 
  labs(x="Age ", y="Cancer", title="Cancer as a function of Age: \nSplit by year and race") + theme(plot.title = element_text(size=20, face="bold", vjust=1, lineheight=0.6), 
        legend.title = element_text(colour="forestgreen", size=10, face="bold"), 
        axis.title.x = element_text(color="forestgreen", vjust=-0.35),
      axis.title.y = element_text(color="forestgreen" , vjust=0.35))+
  scale_color_discrete(name="Death") 


ggplot(data = death_mechprosthetics, aes(as.factor(congestive_heart_failure), age)) +
  geom_violin(alpha=0.5, color="gray") + 
  geom_jitter(alpha=0.5, aes(color = as.factor(death)), position = position_jitter(width = 0.1)) +
  coord_flip() + 
  labs(x="Congestive Heart Failure ", y="Age", title="Congestive Heart Failure as a function of Age: \nSplit by death") +
  theme(plot.title = element_text(size=20, face="bold", vjust=1, lineheight=0.6)) +
  scale_color_discrete(name="Death") 


thecor<-round(cor(death_mechprosthetics[,sort(c("age", "emergent_admission", 
                                               "concomitant_tricuspid_valve_repair", "coagulation",
                                               "hypertension","diabetes_mellitus", "sepsis",
                                               "congestive_heart_failure", "atrial_fibrillation",
                                               "peripheral_vascular_disease", 
                                               "cerebro_vascular_disease", 
                                               "chronic_obstructive_pulmonary_disease",
                                               "chronic_kidney_disease", "liver_disease", "cancer",
                                               "death"))], 
                  method="pearson", 
                  use="pairwise.complete.obs"), 
              2)
thecor[lower.tri(thecor)]<-NA
print(thecor)

thecor<-melt(thecor)
thecor$Var1<-as.character(thecor$Var1)
thecor$Var2<-as.character(thecor$Var2)
#Now we will use the "long" format using the melt function from the reshape2 package and I'll drop the records with NA values.
thecor<-na.omit(thecor)

ggplot(thecor, aes(Var2, Var1))+
 geom_tile(data=thecor, aes(fill=value), color="white")+
 scale_fill_gradient2(low="red", high="green", mid="white", 
  midpoint=0, limit=c(-1,1),name="Correlation\n(Pearson)")+
 theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1))+
 coord_equal() + 
  labs(title="Correlations in mechanical prosthetics group" , x = "", y = "")

```

Positive Correlations
Apart from the correlations we generated while simlating the death variable, we see some more interesting positive correlations in the data. These correlations are not that stroong though. These are: Sepsis and chronic kidney disease, diabetes mellitus and coagulation. Age and death ofcourse show high positive correlatin as they are intentionally coded that way. Similary death and congestive heart failure show strong positive correlation.

Negative Correlation
NEgative correlations or confounders were not coded in the data. However, we can notice that there is negative correlation between emergent admission and cerebro-vascular disease. Chronic obstructive pulmonay disease and cerebro-vascular disease also show strong negative correlation.

<H2>Data Analysis</H2>

Now, we will group these people in one single data.frame to apply survival analysis on this data, based on the groups they belong to.

```{r}
final_data <- rbind(death_mechprosthetics, death_bioprosthetics)
observations <- nrow(final_data)

# We could now randomly disperse these rows in the data frae. There is no requirement to do so but it just looks more like an original data frame if we do that. NOTE:it removes the paired matching
#grouped_data <- sample.rows(final_data, observations, replace=FALSE)
```

"final_data" data.frame now holds our final data frame on whch we will apply survival analysis.

<H4>Survival Analysis </H4>

Classically, Survival Analysis is the analysis of time to death. It is composed of:
1. The underlying Hazard function (How the risk of death per unit time changes over time at baseline covariates)
2. The effect parameters (How the hazard varies in response to the covariates)

<B>Estimating survival based on only the groups data belongs to</B>

```{r}
survival_model_groups <- survfit(Surv(death)~group, data = final_data)
summary(survival_model_groups)
#This shows that the possibility of survival of people who had not died. The people who underwent mechanical prosthetic replacement and were still alive after the surgery have a 29.5% chance of survival. However, the people who had undergone the bioprosthetic replacement had a 39.6% chance of survival.

#survdiff(Surv(death) ~ year, data = final_data)
survival_model_years <- survfit(Surv(death)~year, data = final_data)
summary(survival_model_years)
#Based on the year in which people had their surgery, people who are alive had a similar chance of survival. (Except for those who underwent surgery in 2007)

#survdiff(Surv(death) ~ year+group, data = final_data)
survival_model <- survfit(Surv(death)~year+group, data = final_data)
summary(survival_model)
#It can be seen that when we dive further into the survival chances based on the type of surgery and the year in which they undwent the surgery, both grous showed a similar chance of death; apart from the years: 1997, 1998, 2002, 2004 and 2006, where the mechanical group displayed a higher chance of survival.
```

<B>Cox Regression model</B>

The cox regression model based on proportions is the most common model used to determine the effects of covariates on survival. It is a semi-parametric model as:
*The baseline hazard function is unspecified
*The effects of the covariates are multiplicative
*Doesn't make arbitrary assumptions about the shape/form of the baseline hazard function

coxph is used for analysis when we have paired data. Cox Model is used for analysis of Survival data and finding out relationship between Survival and covariates (also called explanatory variables or predictors) .

One of the key assumptions in Cox Regression is that the proportional hazards does not depend on the covariates. This we have verified in the analysis below.


```{r}
#create survival object
final_data$SurvObj <- with(final_data, Surv(death))

# Cox regression using coxph
cox_regression_model <- coxph(SurvObj ~age + emergent_admission +        
        concomitant_tricuspid_valve_repair + coagulation + hypertension +
        diabetes_mellitus + sepsis + coronary_artery_disease +
        congestive_heart_failure + atrial_fibrillation + 
        peripheral_vascular_disease + cerebro_vascular_disease +
        chronic_obstructive_pulmonary_disease + chronic_kidney_disease +
                               liver_disease + cancer + group + strata(year), data =  final_data)
print(cox_regression_model)

## Check for violation of proportional hazard (constant HR over time)
resi <- cox.zph(cox_regression_model)
print(resi)
#Since the rho is almost the same over all the variables, there is no violation of propotional hazards.
```

*From the coxph model set we can see that the beta coefficients of most variables except group, cancer and congestive heart failure are close to zero (half positive and half negative).

*The Z-scores of the cox model are known as he Wald statistics and are calculated by dividing beta with its corresponding standard error. It is assumed as asymptotically standard normal under the hypothesis that the corresonding beta is zero. 

*The p-value corresponds to the z-statistics. If the p-value is lower than 5% then the null hypothesis of beta=0 can be rejected with a 95% confidence interval.

_Conclusion_
In our analysis we can see that for almost all predictors, we do not have enough evidence to reject the null hypothesis that beta=0 (except group, conjestive heart failure, cancer and age)
```{r}
print(summary(cox_regression_model))
```

Concordance tells how well  0's are separated from 1's in the model. This model separates os frm 1s 88.1% percent of the times. 


<H4>Random Forests</H4>

Fitting random forests on the basis of death

```{r}
#we convert the death variable to factors otherwise R will treat death as integers (using method = anova)   
death_tree <- rpart(as.factor(death) ~ age + emergent_admission +        
                     concomitant_tricuspid_valve_repair + coagulation + hypertension +
                     diabetes_mellitus + sepsis + coronary_artery_disease +
                     congestive_heart_failure + atrial_fibrillation + 
                     peripheral_vascular_disease + cerebro_vascular_disease +
                     chronic_obstructive_pulmonary_disease + chronic_kidney_disease +
                     liver_disease + cancer + group+ year, data=final_data)

# extra=2:  edisplays the number of correct classifications and the number of observations in the node.
#Snip = TRUE will allow you to interactively extract the values at any node which you click on.
rpart.plot(death_tree, extra = 2,  under = TRUE, clip.right.labs = FALSE, varlen = 0, type = 4, snip = TRUE)
 
```

This shows that the only important predictors are: age, congestive heart failure and the group. This tree also shows the classification efficiency at every node. Eg. the classification efficiency at the node for age<60 is that it classified accurately 602 times out of the 609 times it encountered an observation. Thus, as can be seen above, random forests give the correct classification score of every node.